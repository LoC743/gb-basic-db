# Урок 5. Транзакции и оптимизация запросов

## 1. Реализовать практические задания на примере других таблиц и запросов.

### Блокировка чтения

Для блокировки чтения нужно воспользоваться запросом `lock table <название_таблицы> read;`

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/1.png)
![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/2.png)

При попытке обновить данные в этой таблице, запрос будет ожидать, пока блокировка не будет снята. Его ожидание можно увидеть в таблице `processlist`.
При этом запросы на получение данных будут доступны для выполнения.

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/3.png)
![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/7.png)

При разблокировке командой `unlock tables;`, запрос который был в ожидании выполняется.

### Блокировка записи

Для блокировки записи требуется воспользоваться запросом `lock table <название_таблицы> write;`

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/4.png)
![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/5.png)

При попытке получить данные из этой таблицы, запрос будет ожидать, пока блокировка не будет снята. Это так же можно увидеть в таблице `processlist`.
При этом можно выполнять запросы, которые будут изменять данные в таблице.

В запросе, который потребовал данные из таблицы, буду отражены самые последние данные, после всех изменений, которые были применены до снятия блокировки.

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/6.png)

## 2. Подумать, какие операции являются транзакционными, и написать несколько примеров с транзакционными запросами.

-   Обмен предметами между людьми. Если обе стороны готовы обменяться, то транзакция совершается. Если хотя бы одна сторона обмена отказывается, то транзакция откатывается.
-   Покупка `_` (вещей, подписки и тд) в магазине(интернет магазине). Если обе стороны готовы обменяться, то транзакция совершается. Если товара в наличии нет, или у покупателя не хватает денег на совершение покупки, то тразакция откатывается.

## 3. Проанализировать несколько запросов с помощью EXPLAIN.

Запрос, который получает все города, которые находятся в Московской области:

```
SELECT
    _cities.id,
    _cities.country_id,
    _cities.important,
    _cities.region_id,
    _regions.title region_title,
    _cities.title city_title
FROM
    _cities
        JOIN
    _regions ON _cities.region_id = _regions.id
WHERE _regions.title = 'Московская область';
```

Команда `EXPLAIN` выводит информацию, которая позволит обнаружить медленные запросы и сокртатить время, которое затрачивается на обработку запроса.
| Переменная | Значение |
| ---------- | -------- |
| id | Идентификатор таблицы в запросе. EXPLAIN создает по одной записи для каждой таблици в запросе. |
| select_type | Возможные значения: SIMPLE, PRIMARY, UNION, DEPENDENT UNION, DERIVED. |
| table | Имя таблицы или который производится чтение. |
| type | Тип объединения, которое используется. Возможные значения: eq_ref, ref, range, index, all. |
| possible_keys | Список индексов. |
| key | Название индекса, который используется. |
| key_len | Размер ключа в байтах. |
| ref | Столбцы или значения, которые используются для сравнения с ключем. |
| rows | Количество строк, которые необходимы для проверки, обработки запроса |
| filtered | Процент данных, которые мы выбрали из обработанных. |
| extra | Дополнительная информация о запросе |

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/11.png)

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/10.png)

По полученной информации можно сделать вывод, что таблица `_cities` является оптимизированной. А в таблице `_regions` происходит полный перебор всех строк. Чтобы этого избежать, можно добавить индекс на то поле, которое используется в запросе. Это поле `title`.

После добавления индекса на поле `title`, получаем следующие результаты:

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/8.png)

![](https://github.com/LoC743/gb-basic-db/blob/transactions/transactions/images/9.png)

Время без оптимизации: 0.011 sec / 0.039 sec
Время с оптимизацией: 0.0016 sec / 0.0018 sec
